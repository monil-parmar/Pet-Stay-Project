<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Redirecting...</title>
  <script src="https://cdn.jsdelivr.net/npm/aws-amplify@latest/dist/aws-amplify.min.js"></script>
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1471.0.min.js"></script>
  <script src="/assets/js/config.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 100px;
    }
  </style>
</head>

<body>
  <h2>Logging you in... Please wait.</h2>

<script>
  window.addEventListener('load', async () => {
    const { Amplify, Auth } = window.aws_amplify;

    if (!Amplify || !Auth) {
      console.error("Amplify not available.");
      document.body.innerHTML = "<p style='color:red'>Error loading AWS Amplify.</p>";
      return;
    }

    // Configure Amplify
    Amplify.configure({
      Auth: {
        region: window.PETSTAY_CONFIG.AWS_REGION,
        userPoolId: window.PETSTAY_CONFIG.COGNITO_USER_POOL_ID,
        userPoolWebClientId: window.PETSTAY_CONFIG.COGNITO_USER_POOL_CLIENT_ID,
        identityPoolId: window.PETSTAY_CONFIG.IDENTITY_POOL_ID,
        oauth: {
          domain: window.PETSTAY_CONFIG.COGNITO_DOMAIN,
          scope: ['email', 'openid', 'phone'],
          redirectSignIn: window.PETSTAY_CONFIG.REDIRECT_SIGN_IN_URL,
          redirectSignOut: window.PETSTAY_CONFIG.REDIRECT_SIGN_OUT_URL,
          responseType: 'code'
        }
      }
    });

    // Configure AWS SDK
    AWS.config.region = window.PETSTAY_CONFIG.AWS_REGION;

    // IoT policy attach function
    async function attachIoTPolicy(identityId) {
      const iot = new AWS.Iot({ region: window.PETSTAY_CONFIG.AWS_REGION });
      try {
        await iot.attachPolicy({
          policyName: 'PetStayAdminIoTAccessPolicy',
          target: identityId
        }).promise();
        console.log("✅ IoT policy attached to:", identityId);
      } catch (error) {
        if (error.code === 'ResourceAlreadyExistsException') {
          console.log("ℹ️ IoT policy already attached to:", identityId);
        } else {
          console.error("❌ Failed to attach IoT policy:", error);
        }
      }
    }

    try {
      const user = await Auth.currentAuthenticatedUser({ bypassCache: true });

      // Wait for session to become valid (retry logic)
      let session;
      for (let i = 0; i < 5; i++) {
        try {
          session = await Auth.currentSession();
          break;
        } catch {
          await new Promise(r => setTimeout(r, 1000));
        }
      }

      if (!session) {
        alert("Session could not be established. Please refresh and try again.");
        return;
      }

      // Extract email
      const idToken = session.getIdToken();
      const email = (idToken.payload.email || idToken.payload["cognito:username"] || "unknown").toLowerCase();

      // Attach IoT policy using identityId
      const credentials = await Auth.currentCredentials();
      const identityId = credentials.identityId;
      console.log("Cognito Identity ID:", identityId);
      await attachIoTPolicy(identityId);

      // Redirection logic
      const urlParams = new URLSearchParams(window.location.search);
      const bookingId = sessionStorage.getItem("bookingId") || urlParams.get("bookingId");
      const fromLogin = sessionStorage.getItem("fromLogin") || urlParams.get("fromLogin");
      const adminLogin = sessionStorage.getItem("adminLogin");

      const allowedStaff = ["petstayteam@outlook.com", "petstayteam@gmail.com"];
      const normalizedAllowed = allowedStaff.map(e => e.trim().toLowerCase());

      if (!normalizedAllowed.includes(email)) {
        alert(`You (${email}) are not authorized to check in guests.`);
        sessionStorage.clear();
        window.location.href = window.PETSTAY_CONFIG.REDIRECT_SIGN_OUT_URL;
        return;
      }

      if (fromLogin === "1" && bookingId) {
        sessionStorage.removeItem("fromLogin");
        sessionStorage.removeItem("bookingId");
        window.location.href = `/checkin.html?bookingId=${bookingId}&fromLogin=1`;
      } else if (adminLogin === "1") {
        sessionStorage.removeItem("adminLogin");
        window.location.href = "/admin-frontend/admin_dashboard.html";
      } else {
        window.location.href = "/";
      }

    } catch (err) {
      console.error("Authentication or redirect failed:", err);
      alert("Login failed. Redirecting to home.");
      window.location.href = window.PETSTAY_CONFIG.REDIRECT_SIGN_OUT_URL;
    }
  });
</script>
</body>
</html>
